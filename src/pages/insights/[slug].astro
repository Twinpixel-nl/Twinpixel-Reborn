---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Button from "../../components/Button.astro";
import { getCollection, getEntryBySlug, render } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("insights", ({ data }) => !data.draft);
  return posts.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const entry = await getEntryBySlug("insights", slug);
if (!entry) throw new Error(`Insight niet gevonden`);

const { Content } = await render(entry);
const { data } = entry;

const formatDate = (d) =>
  new Intl.DateTimeFormat("nl-NL", { year: "numeric", month: "long", day: "2-digit" }).format(d);
---

<BaseLayout title={`${data.title} | Insights`} description={data.description}>
  <!-- PROGRESS BAR (UX GOUD) -->
  <div class="progress-container">
    <div class="progress-bar" id="myBar"></div>
  </div>

  <main class="insight-article">
    <header class="container narrow article-header">
      <a href="/insights" class="back-link">← Alle insights</a>
      <div class="meta-info">
        <span class="cat-badge">{data.category || "Insight"}</span>
        <time>{formatDate(data.date)}</time>
      </div>
      <h1 class="h1">{data.title}</h1>
    </header>

    <div class="container narrow">
      <article class="reading-shell">
        {data.image?.src && (
          <div class="main-image">
            <img src={data.image.src} alt={data.image.alt || data.title} />
          </div>
        )}

        <div class="prose">
          <!-- De Content wordt hier ingeladen -->
          <Content />
        </div>

        <footer class="article-footer">
          <div class="cta-card">
            <p class="kicker">TwinPixel Insights</p>
            <h3>Dit vertalen naar jouw website?</h3>
            <p>We helpen je graag om deze principes toe te passen op jouw specifieke situatie.</p>
            <div class="cta-actions">
              <Button href="/contact" variant="primary" label="Project starten" />
            </div>
          </div>
        </footer>
      </article>
    </div>
  </main>
</BaseLayout>

<script>
  // Script voor de lees-progressie balk
  window.onscroll = function() { myFunction() };
  function myFunction() {
    var winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    var height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    var scrolled = (winScroll / height) * 100;
    document.getElementById("myBar").style.width = scrolled + "%";
  }
</script>

<style>
  .insight-article { padding: 140px 0 100px; }
  .container.narrow { max-width: 800px; margin: 0 auto; width: calc(100% - 3rem); }

  /* --- PROGRESS BAR --- */
  .progress-container {
    position: fixed; top: 72px; /* Hoogte van je navbar */
    left: 0; z-index: 100; width: 100%; height: 2px; background: transparent;
  }
  .progress-bar { height: 2px; background: var(--brand); width: 0%; }

  /* --- HEADER --- */
  .article-header { text-align: left; margin-bottom: 40px; }
  .back-link { font-size: 13px; color: var(--muted2); text-decoration: none; margin-bottom: 24px; display: inline-block; }
  .meta-info { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
  .cat-badge { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--brand); letter-spacing: 1px; }
  time { font-size: 13px; color: var(--muted2); }
  .h1 { font-size: clamp(32px, 5vw, 48px); font-weight: 800; line-height: 1.1; color: #fff; letter-spacing: -0.04em; }

  /* --- READING SHELL --- */
  .reading-shell {
    background: rgba(255, 255, 255, 0.01);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 24px;
    overflow: hidden;
  }

  .main-image img { width: 100%; aspect-ratio: 16/8; object-fit: cover; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }

  .prose { padding: 60px 60px; font-size: 18px; line-height: 1.85; color: rgba(255, 255, 255, 0.7); }

  /* --- DE LIJNEN (DE OVERZICHTELIJKHEID) --- */
  
  /* Een subtiele lijn boven elke H2 (hoofdstukken) */
  .prose :global(h2) {
    font-size: 28px; font-weight: 700; color: #fff;
    margin: 64px 0 24px; padding-top: 40px;
    border-top: 1px solid rgba(255, 255, 255, 0.06); /* De scheidingslijn */
    letter-spacing: -0.02em;
  }

  /* De eerste H2 heeft geen lijn nodig */
  .prose :global(h2:first-of-type) { border-top: none; padding-top: 0; margin-top: 24px; }

  .prose :global(h3) { font-size: 20px; font-weight: 600; color: #fff; margin: 32px 0 16px; }
  .prose :global(p) { margin-bottom: 24px; }

  /* Subtiele scheiding voor lijsten */
  .prose :global(ul) { 
    margin: 32px 0; padding: 24px; 
    background: rgba(255, 255, 255, 0.015); 
    border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.03);
  }
  .prose :global(li) { margin-bottom: 12px; list-style-type: none; position: relative; padding-left: 20px; }
  .prose :global(li::before) { content: '→'; position: absolute; left: 0; color: var(--brand); font-weight: bold; }

  /* --- FOOTER --- */
  .article-footer { padding: 0 60px 60px; }
  .cta-card {
    background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05);
    padding: 40px; border-radius: 20px; text-align: center;
  }
  .kicker { font-size: 11px; text-transform: uppercase; color: var(--brand); font-weight: 700; margin-bottom: 12px; }
  .cta-card h3 { color: #fff; font-size: 22px; margin-bottom: 12px; }
  .cta-card p { font-size: 15px; color: var(--muted); margin-bottom: 24px; }

  /* Mobiel */
  @media (max-width: 768px) {
    .prose { padding: 40px 20px; font-size: 17px; }
    .article-footer { padding: 0 20px 40px; }
    .prose :global(h2) { font-size: 24px; margin: 48px 0 20px; }
  }
</style>